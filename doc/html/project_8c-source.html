<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gerbv: src/project.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8-20040928 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>project.c</h1><a href="project_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
00003 <span class="comment"> * This file is a part of gerbv.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *   Copyright (C) 2000-2003 Stefan Petersen (spe@stacken.kth.se)</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * $Id$</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00011 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00012 <span class="comment"> * (at your option) any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00017 <span class="comment"> * GNU General Public License for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
00022 <span class="comment"> */</span>
00023 
00028 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00030 <span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#ifdef HAVE_STDLIB_H</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00037 
00038 <span class="preprocessor">#ifdef HAVE_STRING_H</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 <span class="preprocessor">#ifdef HAVE_SYS_TYPES_H</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046 <span class="preprocessor">#ifdef HAVE_SYS_STAT_H</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
00050 <span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
00052 <span class="preprocessor">#endif</span>
00053 <span class="preprocessor"></span>
00054 <span class="preprocessor">#include "gerb_error.h"</span>
00055 <span class="preprocessor">#include "gerb_file.h"</span>
00056 <span class="preprocessor">#include "gerbv_screen.h"</span>
00057 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00058 <span class="preprocessor">#include "scheme-private.h"</span>
00059 <span class="preprocessor">#include "search_gui.h"</span>
00060 
00061 
00062 
00063 <span class="keyword">static</span> <a class="code" href="structproject__list__t.html">project_list_t</a> *plist_top = NULL;
00064 
00065 <span class="keyword">static</span> <span class="keywordtype">void</span>
00066 get_color(scheme *sc, pointer value, <span class="keywordtype">int</span> *color)
00067 {
00068     <span class="keywordtype">int</span> i;
00069     pointer elem;
00070 
00071     <span class="keywordflow">if</span> (!sc-&gt;vptr-&gt;is_vector(value)) {
00072        GERB_MESSAGE(<span class="stringliteral">"Color parameter not a vector\n"</span>);
00073        <span class="keywordflow">return</span>;
00074     }
00075     <span class="keywordflow">if</span> (sc-&gt;vptr-&gt;vector_length(value) != 3) {
00076        GERB_MESSAGE(<span class="stringliteral">"Color vector of incorrect length\n"</span>);
00077        <span class="keywordflow">return</span>;
00078     }
00079     
00080     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
00081        elem = sc-&gt;vptr-&gt;vector_elem(value, i);
00082        <span class="keywordflow">if</span> (sc-&gt;vptr-&gt;is_integer(elem) &amp;&amp; sc-&gt;vptr-&gt;is_number(elem))
00083            color[i] = sc-&gt;vptr-&gt;ivalue(elem);
00084        <span class="keywordflow">else</span> { 
00085            color[i] = -1;
00086            GERB_MESSAGE(<span class="stringliteral">"Illegal color in projectfile\n"</span>);
00087        }
00088     }
00089     
00090     <span class="keywordflow">return</span>;
00091 } <span class="comment">/* get_color */</span>
00092 
00093 
00094 <span class="keyword">static</span> <span class="keywordtype">char</span> *
00095 get_value_string(scheme *sc, pointer value)
00096 {
00097     <span class="keywordflow">if</span> (!sc-&gt;vptr-&gt;is_string(value))
00098        <span class="keywordflow">return</span> NULL;
00099 
00100     <span class="keywordflow">return</span> sc-&gt;vptr-&gt;string_value(value);
00101 } <span class="comment">/* get_value_string */</span>
00102 
00103 
00105 <span class="keywordtype">char</span> *
<a name="l00106"></a><a class="code" href="project_8h.html#a5">00106</a> <a class="code" href="project_8h.html#a5">convert_path_separators</a>(<span class="keywordtype">char</span>* path, <span class="keywordtype">int</span> conv_flag)
00107 {
00108     <span class="keywordtype">char</span>     *hit_in_path;
00109     
00110     <span class="keywordflow">switch</span> (conv_flag) {
00111     
00112     <span class="keywordflow">case</span> MINGW_UNIX:
00113         <span class="keywordflow">while</span>   ((hit_in_path = strchr(path, <span class="charliteral">'\\'</span>))) {
00114             *hit_in_path = <span class="charliteral">'/'</span>;
00115         }
00116         <span class="keywordflow">break</span>;
00117     <span class="keywordflow">case</span> UNIX_MINGW:
00118          <span class="keywordflow">while</span>   ((hit_in_path = strchr(path, <span class="charliteral">'/'</span>))) {
00119             *hit_in_path = <span class="charliteral">'\\'</span>;
00120         }
00121         <span class="keywordflow">break</span>;
00122     }    
00123     <span class="keywordflow">return</span> path;
00124 }<span class="comment">/* convert_path_separators */</span>
00125 
00126 
00127 <span class="keyword">static</span> pointer
00128 define_layer(scheme *sc, pointer args)
00129 {
00130     pointer car_el, cdr_el, name, value;
00131     <span class="keywordtype">int</span> layerno;
00132     <a class="code" href="structproject__list__t.html">project_list_t</a> *plist_tmp = NULL;
00133 
00134     <span class="keywordflow">if</span> (!sc-&gt;vptr-&gt;is_pair(args)){
00135        GERB_MESSAGE(<span class="stringliteral">"define-layer!: Too few arguments\n"</span>);
00136        <span class="keywordflow">return</span> sc-&gt;F;
00137     }
00138 
00139     car_el = sc-&gt;vptr-&gt;pair_car(args);
00140     cdr_el = sc-&gt;vptr-&gt;pair_cdr(args);
00141 
00142     <span class="keywordflow">if</span> (!sc-&gt;vptr-&gt;is_integer(car_el) || !sc-&gt;vptr-&gt;is_number(car_el)) {
00143        GERB_MESSAGE(<span class="stringliteral">"define-layer!: Layer number missing/incorrect\n"</span>);
00144        <span class="keywordflow">return</span> sc-&gt;F;
00145     }
00146 
00147     layerno = sc-&gt;vptr-&gt;ivalue(car_el);
00148 
00149     car_el = sc-&gt;vptr-&gt;pair_car(cdr_el);
00150     cdr_el = sc-&gt;vptr-&gt;pair_cdr(cdr_el);
00151 
00152     plist_tmp = (<a class="code" href="structproject__list__t.html">project_list_t</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structproject__list__t.html">project_list_t</a>));
00153     memset(plist_tmp, 0, <span class="keyword">sizeof</span>(<a class="code" href="structproject__list__t.html">project_list_t</a>));
00154     plist_tmp-&gt;<a class="code" href="structproject__list__t.html#o5">next</a> = plist_top;
00155     plist_top = plist_tmp;
00156     plist_top-&gt;<a class="code" href="structproject__list__t.html#o0">layerno</a> = layerno;
00157 
00158     <span class="keywordflow">while</span> (sc-&gt;vptr-&gt;is_pair(car_el)) {
00159 
00160        name = sc-&gt;vptr-&gt;pair_car(car_el);
00161        value =  sc-&gt;vptr-&gt;pair_cdr(car_el);
00162 
00163        <span class="keywordflow">if</span> (!sc-&gt;vptr-&gt;is_symbol(name)) {
00164            GERB_MESSAGE(<span class="stringliteral">"define-layer!:non-symbol found, ignoring\n"</span>);
00165            <span class="keywordflow">goto</span> end_name_value_parse;
00166        }
00167 
00168        <span class="keywordflow">if</span> (strcmp(sc-&gt;vptr-&gt;symname(name), <span class="stringliteral">"color"</span>) == 0) {
00169            get_color(sc, value, plist_top-&gt;<a class="code" href="structproject__list__t.html#o2">rgb</a>);
00170        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(sc-&gt;vptr-&gt;symname(name), <span class="stringliteral">"filename"</span>) == 0) {
00171 <span class="preprocessor">#ifdef USE_GTK2</span>
00172 <span class="preprocessor"></span><span class="preprocessor">#if defined (__MINGW32__)    </span>
00173 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a> = <a class="code" href="project_8h.html#a5">convert_path_separators</a>(strdup(get_value_string(sc, value)), UNIX_MINGW);
00174 <span class="preprocessor">#else</span>
00175 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a> = strdup(get_value_string(sc, value));
00176 <span class="preprocessor">#endif</span>
00177 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o4">is_pnp</a> = 0;
00178     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(sc-&gt;vptr-&gt;symname(name), <span class="stringliteral">"pick_and_place"</span>) == 0) {
00179 <span class="preprocessor">#if defined (__MINGW32__)    </span>
00180 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a> = <a class="code" href="project_8h.html#a5">convert_path_separators</a>(strdup(get_value_string(sc, value)), UNIX_MINGW);
00181 <span class="preprocessor">#else</span>
00182 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a> = strdup(get_value_string(sc, value));
00183 <span class="preprocessor">#endif    </span>
00184 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o4">is_pnp</a> = 1;
00185 <span class="preprocessor">#else</span>
00186 <span class="preprocessor"></span>            plist_top-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a> = strdup(get_value_string(sc, value));             
00187 <span class="preprocessor">#endif            </span>
00188 <span class="preprocessor"></span>       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(sc-&gt;vptr-&gt;symname(name), <span class="stringliteral">"inverted"</span>) == 0) {
00189            <span class="keywordflow">if</span> (value ==  sc-&gt;F) {
00190               plist_top-&gt;<a class="code" href="structproject__list__t.html#o3">inverted</a> = 0;
00191            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == sc-&gt;T) {
00192               plist_top-&gt;<a class="code" href="structproject__list__t.html#o3">inverted</a> = 1;
00193            } <span class="keywordflow">else</span> {
00194               GERB_MESSAGE(<span class="stringliteral">"Argument to inverted must be #t or #f\n"</span>);
00195            }
00196        }
00197 
00198     end_name_value_parse:
00199        car_el = sc-&gt;vptr-&gt;pair_car(cdr_el);
00200        cdr_el = sc-&gt;vptr-&gt;pair_cdr(cdr_el);
00201     }
00202     
00203     <span class="keywordflow">return</span> sc-&gt;NIL;
00204 } <span class="comment">/* define_layer */</span>
00205 
00206 
00216 <a class="code" href="structproject__list__t.html">project_list_t</a> *
<a name="l00217"></a><a class="code" href="project_8h.html#a3">00217</a> <a class="code" href="project_8h.html#a3">read_project_file</a>(<span class="keywordtype">char</span> *filename)
00218 {
00219     <span class="keyword">struct </span>stat stat_info;
00220     scheme *sc;
00221     FILE *fd;
00222     <span class="keywordtype">char</span> *initdirs[] = {BACKEND_DIR, <a class="code" href="gerbv_8c.html#a0">screen</a>.execpath, <span class="stringliteral">"."</span>, 
00223                      <span class="stringliteral">"$GERBV_SCHEMEINIT"</span>, NULL};
00224     <span class="keywordtype">char</span> *initfile;
00225 
00226     <span class="keywordflow">if</span> (stat(filename, &amp;stat_info)) {
00227        GERB_MESSAGE(<span class="stringliteral">"Failed to read %s\n"</span>, filename);
00228        <span class="keywordflow">return</span> NULL;
00229     }
00230 
00231     <span class="keywordflow">if</span> (!S_ISREG(stat_info.st_mode)) {
00232        GERB_MESSAGE(<span class="stringliteral">"Failed to read %s\n"</span>, filename);
00233        <span class="keywordflow">return</span> NULL;
00234     }
00235 
00236     sc = scheme_init_new();
00237     scheme_set_output_port_file(sc, stdout);
00238 
00239     <span class="keywordflow">if</span>(!sc){
00240        GERB_FATAL_ERROR(<span class="stringliteral">"Couldn't init scheme\n"</span>);
00241        exit(1);
00242     }
00243 
00244     initfile = gerb_find_file(<span class="stringliteral">"init.scm"</span>, initdirs);
00245     <span class="keywordflow">if</span> (initfile == NULL) {
00246        GERB_MESSAGE(<span class="stringliteral">"Didn't find init.scm.\n"</span>);
00247        <span class="keywordflow">return</span> NULL;
00248     }
00249     <span class="keywordflow">if</span> ((fd = fopen(initfile, <span class="stringliteral">"r"</span>)) == NULL) {
00250        GERB_FATAL_ERROR(<span class="stringliteral">"Couldn't open %s\n"</span>, initfile);
00251        exit(1);
00252     }
00253     sc-&gt;vptr-&gt;load_file(sc, fd);
00254     fclose(fd);
00255 
00256     sc-&gt;vptr-&gt;scheme_define(sc, sc-&gt;global_env, 
00257                          sc-&gt;vptr-&gt;mk_symbol(sc, <span class="stringliteral">"define-layer!"</span>),
00258                          sc-&gt;vptr-&gt;mk_foreign_func(sc, define_layer));
00259 
00260     <span class="keywordflow">if</span> ((fd = fopen(filename, <span class="stringliteral">"r"</span>)) == NULL) {
00261        GERB_MESSAGE(<span class="stringliteral">"Couldn't open project file %s\n"</span>, filename);
00262        <span class="keywordflow">return</span>(NULL);
00263     }
00264 
00265     plist_top = NULL;
00266 
00267     scheme_load_file(sc, fd);
00268     fclose(fd);
00269 
00270     scheme_deinit(sc);
00271 
00272     <span class="keywordflow">return</span> plist_top;
00273 } <span class="comment">/* read_project */</span>
00274 
00275 
00276 <span class="comment">/*</span>
00277 <span class="comment"> * Writes a description of a project to a file </span>
00278 <span class="comment"> * that can be parsed by read_project above</span>
00279 <span class="comment"> */</span>
00280 <span class="keywordtype">int</span> 
00281 write_project_file(<span class="keywordtype">char</span> *filename, <a class="code" href="structproject__list__t.html">project_list_t</a> *project)
00282 {
00283     FILE *fd;
00284     <a class="code" href="structproject__list__t.html">project_list_t</a> *p = project, *tmp;
00285 
00286     <span class="keywordflow">if</span> ((fd = fopen(filename, <span class="stringliteral">"w"</span>)) == NULL) {
00287            GERB_MESSAGE(<span class="stringliteral">"Couldn't save project %s\n"</span>, filename);
00288            <span class="keywordflow">return</span>(-1);
00289     }
00290     <span class="keywordflow">while</span> (p) {
00291        fprintf(fd, <span class="stringliteral">"(define-layer! %d "</span>, p-&gt;<a class="code" href="structproject__list__t.html#o0">layerno</a>);
00292 <span class="preprocessor">#ifdef USE_GTK2    </span>
00293 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((interface.<a class="code" href="struct__InterfaceStruct.html#o21">pnp_filename</a> != NULL) &amp;&amp; (strncmp(p-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a>, interface.<a class="code" href="struct__InterfaceStruct.html#o21">pnp_filename</a>, strlen(interface.<a class="code" href="struct__InterfaceStruct.html#o21">pnp_filename</a>)) == 0)) 
00294 <span class="preprocessor">#if defined (__MINGW32__)    </span>
00295 <span class="preprocessor"></span>           fprintf(fd, <span class="stringliteral">"(cons 'pick_and_place \"%s\")"</span>, <a class="code" href="project_8h.html#a5">convert_path_separators</a>(p-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a>, MINGW_UNIX));
00296 
00297 <span class="preprocessor">#else</span>
00298 <span class="preprocessor"></span>           fprintf(fd, <span class="stringliteral">"(cons 'pick_and_place \"%s\")"</span>, p-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a>);
00299         <span class="keywordflow">else</span>
00300 <span class="preprocessor">#endif</span>
00301 <span class="preprocessor"></span><span class="preprocessor">#if defined (__MINGW32__)</span>
00302 <span class="preprocessor"></span>            fprintf(fd, <span class="stringliteral">"(cons 'filename \"%s\")"</span>, <a class="code" href="project_8h.html#a5">convert_path_separators</a>(p-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a>, MINGW_UNIX));    
00303 <span class="preprocessor">#else</span>
00304 <span class="preprocessor"></span>            fprintf(fd, <span class="stringliteral">"(cons 'filename \"%s\")"</span>, p-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a>);    
00305 
00306 <span class="preprocessor">#endif</span>
00307 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00308 <span class="preprocessor"></span>        
00309             fprintf(fd, <span class="stringliteral">"(cons 'filename \"%s\")"</span>, p-&gt;<a class="code" href="structproject__list__t.html#o1">filename</a>);    
00310 <span class="preprocessor">#endif</span>
00311 <span class="preprocessor"></span>    
00312        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structproject__list__t.html#o3">inverted</a>)
00313            fprintf(fd, <span class="stringliteral">"(cons 'inverted #t)"</span>);
00314        fprintf(fd, <span class="stringliteral">"(cons 'color #(%d %d %d)))"</span>, p-&gt;<a class="code" href="structproject__list__t.html#o2">rgb</a>[0], p-&gt;<a class="code" href="structproject__list__t.html#o2">rgb</a>[1],
00315               p-&gt;<a class="code" href="structproject__list__t.html#o2">rgb</a>[2]);
00316        fprintf(fd, <span class="stringliteral">"\n"</span>);
00317        tmp = p;
00318        p = p-&gt;<a class="code" href="structproject__list__t.html#o5">next</a>;
00319        free(tmp);
00320        tmp = NULL;
00321     }
00322 
00323     fclose(fd);
00324 
00325     <span class="keywordflow">return</span>(0);
00326 } <span class="comment">/* write_project */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Oct 13 16:09:19 2004 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.8-20040928 </small></address>
</body>
</html>
