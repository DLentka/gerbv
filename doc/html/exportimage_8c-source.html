<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gerbv: src/exportimage.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8-20040928 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>exportimage.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
00003 <span class="comment"> * This file is a part of gerbv.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *   Copyright (C) 2000-2002 Stefan Petersen (spe@stacken.kth.se)</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * Contributed by Dino Ghilardi &lt;dino.ghilardi@ieee.org&gt; </span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * $Id$</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00012 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00013 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00014 <span class="comment"> * (at your option) any later version.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00017 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00018 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00019 <span class="comment"> * GNU General Public License for more details.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00022 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00023 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
00024 <span class="comment"> */</span>
00025 
00026 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">/*</span>
00031 <span class="comment"> * Included only if requested at configure time</span>
00032 <span class="comment"> */</span>
00033 <span class="preprocessor">#ifdef EXPORT_PNG</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;math.h&gt;</span>
00039 
00040 <span class="preprocessor">#include &lt;gdk-pixbuf/gdk-pixbuf.h&gt;</span>
00041 <span class="preprocessor">#include &lt;png.h&gt;</span>
00042 
00043 <span class="preprocessor">#include "exportimage.h"</span>
00044 <span class="preprocessor">#include "draw.h"</span>
00045 <span class="preprocessor">#include "gerbv_screen.h"</span>
00046 
00047 <span class="comment">/* Function prototypes */</span>
00048 <span class="keyword">static</span> gboolean pixbuf_to_file_as_png (GdkPixbuf *pixbuf, <span class="keywordtype">char</span> *filename);
00049 
00050 gboolean
00051 png_export(GdkPixmap* imagetosave, <span class="keywordtype">char</span>* filename)
00052 {
00053        GdkPixbuf *tempPixBuf=NULL;
00054        GdkColormap *colormap=NULL; 
00055        GdkPixmap *curr_pixmap = NULL, *out_pixmap = NULL, *clipmask = NULL;
00056        GdkGC *gc = NULL;
00057        <span class="keywordtype">int</span> width = 0, height = 0, i;
00058        <span class="keywordtype">double</span> dmin_x, dmin_y, dmax_x, dmax_y;
00059        gboolean result = FALSE;
00060        
00061        colormap = gdk_colormap_get_system();
00062        <span class="keywordflow">if</span> (colormap == NULL)
00063            <span class="keywordflow">return</span> FALSE;
00064        
00065        <span class="keywordflow">if</span> (imagetosave) {
00066            gdk_window_get_size(imagetosave, &amp;width, &amp;height);
00067            tempPixBuf = gdk_pixbuf_get_from_drawable(tempPixBuf, imagetosave, 
00068                                                 colormap, 
00069                                                 0, 0, 0, 0, 
00070                                                 width, height);
00071        } <span class="keywordflow">else</span> {
00072 
00073            <span class="comment">/*</span>
00074 <span class="comment">            * Max and min of image gives the size of the image.</span>
00075 <span class="comment">            */</span>
00076            dmax_x = <a class="code" href="gerbv_8c.html#a0">screen</a>.gerber_bbox.x2;
00077            dmax_y = <a class="code" href="gerbv_8c.html#a0">screen</a>.gerber_bbox.y2;
00078            dmin_x = <a class="code" href="gerbv_8c.html#a0">screen</a>.gerber_bbox.x1;
00079            dmin_y = <a class="code" href="gerbv_8c.html#a0">screen</a>.gerber_bbox.y1;
00080            
00081            <span class="comment">/*</span>
00082 <span class="comment">            * Width and height to scaled full size.</span>
00083 <span class="comment">            */</span>
00084            width = (int)floor((dmax_x - dmin_x) * 
00085                             (<span class="keywordtype">double</span>)<a class="code" href="gerbv_8c.html#a0">screen</a>.transf-&gt;scale);
00086            height = (int)floor((dmax_y - dmin_y) * 
00087                          (<span class="keywordtype">double</span>)<a class="code" href="gerbv_8c.html#a0">screen</a>.transf-&gt;scale);
00088            
00089            <span class="comment">/*</span>
00090 <span class="comment">            * Allocate the pixmap and the clipmask (a one pixel pixmap)</span>
00091 <span class="comment">            */</span>
00092            gc = gdk_gc_new(<a class="code" href="gerbv_8c.html#a0">screen</a>.drawing_area-&gt;window);
00093            curr_pixmap = gdk_pixmap_new(<a class="code" href="gerbv_8c.html#a0">screen</a>.drawing_area-&gt;window, width, height,  -1);
00094            out_pixmap = gdk_pixmap_new(<a class="code" href="gerbv_8c.html#a0">screen</a>.drawing_area-&gt;window, width, height,  -1);
00095            clipmask = gdk_pixmap_new(<a class="code" href="gerbv_8c.html#a0">screen</a>.drawing_area-&gt;window, width, height,  1);
00096            
00097            <span class="comment">/* </span>
00098 <span class="comment">            * Set background color </span>
00099 <span class="comment">            */</span>
00100            gdk_gc_set_foreground(gc, <a class="code" href="gerbv_8c.html#a0">screen</a>.background);
00101            gdk_draw_rectangle (out_pixmap, gc, TRUE, 0,0, width, height);
00102 
00103            <span class="comment">/* </span>
00104 <span class="comment">            * This now allows drawing several layers on top of each other.</span>
00105 <span class="comment">            * Higher layer numbers have higher priority in the Z-order. </span>
00106 <span class="comment">            */</span>
00107             <a class="code" href="gerbv_8c.html#a0">screen</a>.transf-&gt;offset[0] = -dmin_x;
00108             <a class="code" href="gerbv_8c.html#a0">screen</a>.transf-&gt;offset[1] = dmax_y;
00109             
00110            <span class="keywordflow">for</span>(i = 0; i &lt; MAX_FILES; i++) {
00111               <span class="keywordflow">if</span> (GTK_TOGGLE_BUTTON(<a class="code" href="gerbv_8c.html#a0">screen</a>.layer_button[i])-&gt;active &amp;&amp;
00112                   <a class="code" href="gerbv_8c.html#a0">screen</a>.file[i]) {
00113               
00114                   <span class="comment">/*</span>
00115 <span class="comment">                   * Fill up image with all the foreground color. Excess</span>
00116 <span class="comment">                   * pixels will be removed by clipmask.</span>
00117 <span class="comment">                   */</span>
00118                   gdk_gc_set_foreground(gc, <a class="code" href="gerbv_8c.html#a0">screen</a>.file[i]-&gt;color);
00119                   gdk_draw_rectangle(curr_pixmap, gc, TRUE, 0, 0, -1, -1);
00120                   
00121                   <span class="comment">/*</span>
00122 <span class="comment">                   * Translation is to get it inside the allocated pixmap,</span>
00123 <span class="comment">                   * which is not always centered perfectly for GTK/X.</span>
00124 <span class="comment">                   */</span>
00125                   image2pixmap(&amp;clipmask, <a class="code" href="gerbv_8c.html#a0">screen</a>.file[i]-&gt;image, <a class="code" href="gerbv_8c.html#a0">screen</a>.transf, 
00126                                 <span class="comment">/*screen.transf-&gt;scale, </span>
00127 <span class="comment">                             -dmin_x*screen.transf-&gt;scale,</span>
00128 <span class="comment">                             dmax_y*screen.transf-&gt;scale, */</span>
00129                              <a class="code" href="gerbv_8c.html#a0">screen</a>.file[i]-&gt;image-&gt;info-&gt;polarity);
00130                   <span class="comment">/* </span>
00131 <span class="comment">                   * Set clipmask and draw the clipped out image onto the</span>
00132 <span class="comment">                   * screen pixmap. Afterwards we remove the clipmask, else</span>
00133 <span class="comment">                   * it will screw things up when run this loop again.</span>
00134 <span class="comment">                   */</span>
00135                   gdk_gc_set_clip_mask(gc, clipmask);
00136                   gdk_gc_set_clip_origin(gc, 0, 0);
00137                   gdk_draw_pixmap(out_pixmap, gc, curr_pixmap, 0,     0,
00138                                 0, 0, -1, -1);
00139                   gdk_gc_set_clip_mask(gc, NULL);
00140               }
00141            }
00142            tempPixBuf = gdk_pixbuf_get_from_drawable(tempPixBuf, out_pixmap,
00143                                                 colormap,
00144                                                 0, 0, 0, 0, 
00145                                                 width, height);
00146        }
00147 
00148        <span class="keywordflow">if</span> (tempPixBuf == NULL)
00149            <span class="keywordflow">return</span> FALSE;
00150 
00151        result = pixbuf_to_file_as_png (tempPixBuf, filename);
00152        
00153        gdk_pixbuf_unref(tempPixBuf);
00154        gdk_colormap_unref(colormap);
00155        <span class="keywordflow">if</span> (curr_pixmap) gdk_pixmap_unref(curr_pixmap);
00156        <span class="keywordflow">if</span> (out_pixmap) gdk_pixmap_unref(out_pixmap);
00157        <span class="keywordflow">if</span> (clipmask) gdk_pixmap_unref(clipmask);
00158        <span class="keywordflow">if</span> (gc) gdk_gc_unref(gc);
00159 
00160        <span class="keywordflow">return</span> result;
00161 } <span class="comment">/* png_export */</span>
00162 
00163 
00164 <span class="keyword">static</span> gboolean 
00165 pixbuf_to_file_as_png(GdkPixbuf *pixbuf, <span class="keywordtype">char</span> *filename)
00166 {
00167        FILE *handle;
00168        <span class="keywordtype">int</span> width, height, depth, rowstride;
00169        guchar *pixels;
00170        png_structp png_ptr;
00171        png_infop info_ptr;
00172        png_text text[2];
00173        png_byte **row_ptr;
00174        <span class="keywordtype">int</span> i;
00175 
00176        g_return_val_if_fail (pixbuf != NULL, FALSE);
00177        g_return_val_if_fail (filename != NULL, FALSE);
00178        g_return_val_if_fail (filename[0] != <span class="charliteral">'\0'</span>, FALSE);
00179 
00180         handle = fopen (filename, <span class="stringliteral">"wb"</span>);
00181         <span class="keywordflow">if</span> (handle == NULL) {
00182            <span class="keywordflow">return</span> FALSE;
00183        }
00184 
00185        png_ptr = png_create_write_struct (PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
00186        <span class="keywordflow">if</span> (png_ptr == NULL) {
00187            fclose (handle);
00188            <span class="keywordflow">return</span> FALSE;
00189        }
00190 
00191        info_ptr = png_create_info_struct (png_ptr);
00192        <span class="keywordflow">if</span> (info_ptr == NULL) {
00193            png_destroy_write_struct (&amp;png_ptr, (png_infopp)NULL);
00194            fclose (handle);
00195            <span class="keywordflow">return</span> FALSE;
00196        }
00197 
00198        png_init_io (png_ptr, handle);
00199        
00200        width = gdk_pixbuf_get_width (pixbuf);
00201        height = gdk_pixbuf_get_height (pixbuf);
00202        depth = gdk_pixbuf_get_bits_per_sample (pixbuf);
00203        pixels = gdk_pixbuf_get_pixels (pixbuf);
00204        rowstride = gdk_pixbuf_get_rowstride (pixbuf);
00205        
00206        png_set_IHDR (png_ptr, info_ptr, width, height,
00207                     depth, PNG_COLOR_TYPE_RGB,
00208                     PNG_INTERLACE_NONE,
00209                     PNG_COMPRESSION_TYPE_DEFAULT,
00210                     PNG_FILTER_TYPE_DEFAULT);
00211        
00212        <span class="comment">/* Some text to go with the png image */</span>
00213        text[0].key = <span class="stringliteral">"Title"</span>;
00214        text[0].text = filename;
00215        text[0].compression = PNG_TEXT_COMPRESSION_NONE;
00216        text[1].key = <span class="stringliteral">"Generator"</span>;
00217        text[1].text = <span class="stringliteral">"gerbv"</span>;
00218        text[1].compression = PNG_TEXT_COMPRESSION_NONE;
00219        png_set_text (png_ptr, info_ptr, text, 2);
00220        
00221        <span class="comment">/* Write header data */</span>
00222        png_write_info (png_ptr, info_ptr);
00223        
00224        <span class="comment">/* Build up a vector of row pointers */</span>   
00225        row_ptr = (png_byte **)g_malloc(height * <span class="keyword">sizeof</span>(png_byte *));
00226        <span class="keywordflow">for</span> (i = 0; i &lt; height; i++) {
00227            row_ptr[i] = (png_byte *)pixels;
00228            pixels += rowstride;
00229        }
00230 
00231        <span class="comment">/* Write it and free the row vector */</span>
00232        png_write_image(png_ptr, row_ptr);
00233        g_free(row_ptr);
00234 
00235        <span class="comment">/* Finish of PNG writing */</span>
00236        png_write_end (png_ptr, info_ptr);
00237        png_destroy_write_struct (&amp;png_ptr, &amp;info_ptr);
00238        
00239        fclose (handle);
00240        <span class="keywordflow">return</span> TRUE;
00241 } <span class="comment">/* pixbuf_to_file_as_png */</span>
00242 
00243 <span class="preprocessor">#endif </span><span class="comment">/* EXPORT_PNG */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Oct 13 16:09:18 2004 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.8-20040928 </small></address>
</body>
</html>
