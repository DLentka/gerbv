<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gerbv: src/draw.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8-20040928 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>draw.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
00003 <span class="comment"> * This file is a part of gerbv.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *   Copyright (C) 2000-2003 Stefan Petersen (spe@stacken.kth.se)</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * $Id$</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00011 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00012 <span class="comment"> * (at your option) any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00017 <span class="comment"> * GNU General Public License for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
00022 <span class="comment"> */</span>
00023 
00024 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00026 <span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00029 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00030 <span class="preprocessor">#include &lt;math.h&gt;</span>  <span class="comment">/* ceil(), atan2() */</span>
00031 
00032 <span class="preprocessor">#ifdef HAVE_STRING_H</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#include &lt;gtk/gtk.h&gt;</span>
00037 
00038 <span class="preprocessor">#include "draw.h"</span>
00039 <span class="preprocessor">#include "draw_amacro.h"</span>
00040 <span class="preprocessor">#include "gerb_error.h"</span>
00041 <span class="preprocessor">#include "gerb_transf.h"</span>
00042 
00043 <span class="preprocessor">#undef round</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define round(x) ceil((double)(x))</span>
00045 <span class="preprocessor"></span>
00046 
00047 <span class="comment">/*</span>
00048 <span class="comment"> * Draws a circle _centered_ at x,y with diameter dia</span>
00049 <span class="comment"> */</span>
00050 <span class="keyword">static</span> <span class="keywordtype">void</span> 
00051 gerbv_draw_circle(GdkPixmap *pixmap, GdkGC *gc, 
00052                 gint filled, gint x, gint y, gint dia)
00053 {
00054     <span class="keyword">static</span> <span class="keyword">const</span> gint full_circle = 23360;
00055     gint real_x = x - dia / 2;
00056     gint real_y = y - dia / 2;
00057     
00058     gdk_draw_arc(pixmap, gc, filled, real_x, real_y, dia, dia, 0, full_circle);
00059     
00060     <span class="keywordflow">return</span>;
00061 } <span class="comment">/* gerbv_draw_circle */</span>
00062 
00063 
00064 <span class="comment">/*</span>
00065 <span class="comment"> * Draws a rectangle _centered_ at x,y with sides x_side, y_side</span>
00066 <span class="comment"> */</span>
00067 <span class="keyword">static</span> <span class="keywordtype">void</span> 
00068 gerbv_draw_rectangle(GdkPixmap *pixmap, GdkGC *gc, 
00069                    gint filled, gint x, gint y, gint x_side, gint y_side)
00070 {
00071     
00072     gint real_x = x - x_side / 2;
00073     gint real_y = y - y_side / 2;
00074     
00075     gdk_draw_rectangle(pixmap, gc, filled, real_x, real_y, x_side, y_side);
00076     
00077     <span class="keywordflow">return</span>;
00078 } <span class="comment">/* gerbv_draw_rectangle */</span>
00079 
00080 
00081 <span class="comment">/*</span>
00082 <span class="comment"> * Draws an oval _centered_ at x,y with x axis x_axis and y axis y_axis</span>
00083 <span class="comment"> */</span> 
00084 <span class="keyword">static</span> <span class="keywordtype">void</span>
00085 gerbv_draw_oval(GdkPixmap *pixmap, GdkGC *gc, 
00086               gint filled, gint x, gint y, gint x_axis, gint y_axis)
00087 {
00088     gint delta = 0;
00089     GdkGC *local_gc = gdk_gc_new(pixmap);
00090 
00091     gdk_gc_copy(local_gc, gc);
00092 
00093     <span class="keywordflow">if</span> (x_axis &gt; y_axis) {
00094        <span class="comment">/* Draw in x axis */</span>
00095        delta = x_axis / 2 - y_axis / 2;
00096        gdk_gc_set_line_attributes(local_gc, y_axis, 
00097                                GDK_LINE_SOLID, 
00098                                GDK_CAP_ROUND, 
00099                                GDK_JOIN_MITER);
00100        gdk_draw_line(pixmap, local_gc, x - delta, y, x + delta, y);
00101     } <span class="keywordflow">else</span> {
00102        <span class="comment">/* Draw in y axis */</span>
00103        delta = y_axis / 2 - x_axis / 2;
00104        gdk_gc_set_line_attributes(local_gc, x_axis, 
00105                                GDK_LINE_SOLID, 
00106                                GDK_CAP_ROUND, 
00107                                GDK_JOIN_MITER);
00108        gdk_draw_line(pixmap, local_gc, x, y - delta, x, y + delta);
00109     }
00110 
00111     gdk_gc_unref(local_gc);
00112 
00113     <span class="keywordflow">return</span>;
00114 } <span class="comment">/* gerbv_draw_oval */</span>
00115 
00116 
00117 <span class="comment">/*</span>
00118 <span class="comment"> * Draws an arc </span>
00119 <span class="comment"> * Draws an arc _centered_ at x,y</span>
00120 <span class="comment"> * direction:  0 counterclockwise, 1 clockwise</span>
00121 <span class="comment"> */</span>
00122 <span class="keyword">static</span> <span class="keywordtype">void</span>
00123 gerbv_draw_arc(GdkPixmap *pixmap, GdkGC *gc,
00124               <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y,
00125               <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height,
00126               <span class="keywordtype">double</span> angle1, <span class="keywordtype">double</span> angle2)
00127 {
00128     gint real_x = x - width / 2;
00129     gint real_y = y - height / 2;
00130 
00131     gdk_draw_arc(pixmap, gc, FALSE, real_x, real_y, width, height, 
00132                (gint)angle1 * 64.0, (gint)(angle2 - angle1) * 64.0);
00133     
00134     <span class="keywordflow">return</span>;
00135 } <span class="comment">/* gerbv_draw_arc */</span>
00136 
00137 
00138 <span class="comment">/*</span>
00139 <span class="comment"> * Convert a gerber image to a GDK clip mask to be used when creating pixmap</span>
00140 <span class="comment"> */</span>
00141 <span class="keywordtype">int</span>
00142 image2pixmap(GdkPixmap **pixmap, <span class="keyword">struct</span> gerb_image *image, 
00143             <a class="code" href="structgerb__transf.html">gerb_transf_t</a> *transf, <span class="keyword">enum</span> polarity_t polarity)
00144 {
00145     GdkGC *gc = gdk_gc_new(*pixmap);
00146     GdkGC *pgc = gdk_gc_new(*pixmap);
00147     <span class="keyword">struct </span>gerb_net *net;
00148     gint x1, y1, x2, y2;
00149     <span class="keywordtype">int</span> p1, p2;
00150     <span class="keywordtype">int</span> cir_width = 0, cir_height = 0;
00151     <span class="keywordtype">int</span> cp_x = 0, cp_y = 0;
00152     GdkPoint *points = NULL;
00153     <span class="keywordtype">int</span> curr_point_idx = 0;
00154     <span class="keywordtype">int</span> in_parea_fill = 0;
00155     GdkColor transparent, opaque;
00156     <a class="code" href="structgerb__transf.html">gerb_transf_t</a> trf;
00157 
00158 
00159     <span class="keywordflow">if</span> (image == NULL || image-&gt;netlist == NULL) {
00160        <span class="comment">/*</span>
00161 <span class="comment">        * Destroy GCs before exiting</span>
00162 <span class="comment">        */</span>
00163        gdk_gc_unref(gc);
00164        gdk_gc_unref(pgc);
00165        
00166        <span class="keywordflow">return</span> 0;
00167     }
00168     
00169     <span class="comment">/*TODO effects of both:combine global transf with image-&gt;transf*/</span>
00170     trf = *transf;
00171     
00172     
00173     <span class="comment">/* Set up the two "colors" we have */</span>
00174     opaque.pixel = 0; <span class="comment">/* opaque will not let color through */</span>
00175     transparent.pixel = 1; <span class="comment">/* transparent will let color through */</span> 
00176 
00177     <span class="comment">/*</span>
00178 <span class="comment">     * Clear clipmask and set draw color depending image on image polarity</span>
00179 <span class="comment">     */</span>
00180     <span class="keywordflow">if</span> (polarity == NEGATIVE) {
00181        gdk_gc_set_foreground(gc, &amp;transparent);
00182        gdk_draw_rectangle(*pixmap, gc, TRUE, 0, 0, -1, -1);
00183        gdk_gc_set_foreground(gc, &amp;opaque);
00184     } <span class="keywordflow">else</span> {
00185        gdk_gc_set_foreground(gc, &amp;opaque);
00186        gdk_draw_rectangle(*pixmap, gc, TRUE, 0, 0, -1, -1);
00187        gdk_gc_set_foreground(gc, &amp;transparent);
00188     }
00189 
00190     <span class="keywordflow">for</span> (net = image-&gt;netlist-&gt;next ; net != NULL; net = net-&gt;next) {
00191         <span class="keywordtype">double</span> x1d, y1d, x2d, y2d;
00192         <span class="keywordtype">double</span> x, y; <span class="comment">/*for circle centre*/</span>
00193         <span class="keywordtype">int</span> x_stop, y_stop; <span class="comment">/* not transformed x2,y2 */</span>
00194         trf.<a class="code" href="structgerb__transf.html#o1">scale</a> = transf-&gt;<a class="code" href="structgerb__transf.html#o1">scale</a>;
00195         <span class="keywordflow">if</span> (net-&gt;unit == MM) 
00196             trf.<a class="code" href="structgerb__transf.html#o1">scale</a> /= 25.4;
00197 
00198        <span class="comment">/*</span>
00199 <span class="comment">        * Scale points with window scaling and translate them</span>
00200 <span class="comment">        */</span>
00201         gerb_transf_apply(image-&gt;info-&gt;offset_a + net-&gt;start_x,image-&gt;info-&gt;offset_b - net-&gt;start_y,
00202             &amp;trf, &amp;x1d, &amp;y1d);
00203         gerb_transf_apply(image-&gt;info-&gt;offset_a + net-&gt;stop_x,image-&gt;info-&gt;offset_b - net-&gt;stop_y,
00204             &amp;trf, &amp;x2d, &amp;y2d);    
00205         x1 = (int)round(x1d);
00206         y1 = (int)round(y1d);
00207         x2 = (int)round(x2d);<span class="comment">/*CHECK ME: Why integer cast?*/</span>
00208         y2 = (int)round(y2d);
00209         x_stop = (int)round(image-&gt;info-&gt;offset_a + net-&gt;stop_x);
00210         y_stop = (int)round(image-&gt;info-&gt;offset_b - net-&gt;stop_y);
00211 
00212        <span class="comment">/* </span>
00213 <span class="comment">        * If circle segment, scale and translate that one too</span>
00214 <span class="comment">        */</span>
00215        <span class="keywordflow">if</span> (net-&gt;cirseg) {
00216            cir_width = (int)round(net-&gt;cirseg-&gt;width * trf.<a class="code" href="structgerb__transf.html#o1">scale</a>); <span class="comment">/*CHECK ME later: take into account rotation and other matrix trafos*/</span>
00217            cir_height = (int)round(net-&gt;cirseg-&gt;height * trf.<a class="code" href="structgerb__transf.html#o1">scale</a>);
00218             gerb_transf_apply(image-&gt;info-&gt;offset_a + net-&gt;cirseg-&gt;cp_x,image-&gt;info-&gt;offset_b - net-&gt;cirseg-&gt;cp_y,
00219             &amp;trf, &amp;x, &amp;y);  
00220            cp_x = (int)round(x);
00221            cp_y = (int)round(y);
00222             <span class="comment">/* FIXME recalculate angles as well */</span>
00223        }
00224 
00225        <span class="comment">/*</span>
00226 <span class="comment">        * Set GdkFunction depending on if this (gerber) layer is inverted</span>
00227 <span class="comment">        * and allow for the photoplot being negative.</span>
00228 <span class="comment">        */</span>
00229        gdk_gc_set_function(gc, GDK_COPY);
00230        <span class="keywordflow">if</span> ((net-&gt;layer_polarity == CLEAR) != (polarity == NEGATIVE))
00231            gdk_gc_set_foreground(gc, &amp;opaque);
00232        <span class="keywordflow">else</span>
00233            gdk_gc_set_foreground(gc, &amp;transparent);
00234 
00235        <span class="comment">/*</span>
00236 <span class="comment">        * Polygon Area Fill routines</span>
00237 <span class="comment">        */</span>
00238        <span class="keywordflow">switch</span> (net-&gt;interpolation) {
00239        <span class="keywordflow">case</span> PAREA_START :
00240            points = (GdkPoint *)malloc(<span class="keyword">sizeof</span>(GdkPoint) *  net-&gt;nuf_pcorners);
00241            <span class="keywordflow">if</span> (points == NULL) {
00242               GERB_FATAL_ERROR(<span class="stringliteral">"Malloc failed\n"</span>);
00243            }
00244            memset(points, 0, <span class="keyword">sizeof</span>(GdkPoint) *  net-&gt;nuf_pcorners);
00245            curr_point_idx = 0;
00246            in_parea_fill = 1;
00247            <span class="keywordflow">continue</span>;
00248        <span class="keywordflow">case</span> PAREA_END :
00249            gdk_gc_copy(pgc, gc); 
00250            gdk_gc_set_line_attributes(pgc, 1, 
00251                                    GDK_LINE_SOLID, 
00252                                    GDK_CAP_PROJECTING, 
00253                                    GDK_JOIN_MITER);
00254            gdk_draw_polygon(*pixmap, pgc, 1, points, curr_point_idx);
00255            free(points);
00256            points = NULL;
00257            in_parea_fill = 0;
00258            <span class="keywordflow">continue</span>;
00259        <span class="keywordflow">default</span> :
00260            <span class="keywordflow">break</span>;
00261        }
00262 
00263        <span class="keywordflow">if</span> (in_parea_fill) {
00264            points[curr_point_idx].x = x2;
00265            points[curr_point_idx].y = y2;
00266            curr_point_idx++;
00267            <span class="keywordflow">continue</span>;
00268        }
00269 
00270        <span class="comment">/*</span>
00271 <span class="comment">        * If aperture state is off we allow use of undefined apertures.</span>
00272 <span class="comment">        * This happens when gerber files starts, but hasn't decided on </span>
00273 <span class="comment">        * which aperture to use.</span>
00274 <span class="comment">        */</span>
00275        <span class="keywordflow">if</span> (image-&gt;aperture[net-&gt;aperture] == NULL) {
00276            <span class="keywordflow">if</span> (net-&gt;aperture_state != OFF)
00277               GERB_MESSAGE(<span class="stringliteral">"Aperture [%d] is not defined\n"</span>, net-&gt;aperture);
00278            <span class="keywordflow">continue</span>;
00279        }
00280 
00281        <span class="comment">/*</span>
00282 <span class="comment">        * "Normal" aperture drawing routines</span>
00283 <span class="comment">        */</span>
00284         trf.<a class="code" href="structgerb__transf.html#o1">scale</a> = transf-&gt;<a class="code" href="structgerb__transf.html#o1">scale</a>; <span class="comment">/*TODO must be  changed once image-&gt;transf and transf are combined*/</span>
00285        <span class="keywordflow">if</span> (image-&gt;aperture[net-&gt;aperture]-&gt;unit == MM)
00286            trf.<a class="code" href="structgerb__transf.html#o1">scale</a> /=  25.4;
00287 
00288 
00289        <span class="keywordflow">switch</span> (net-&gt;aperture_state) {
00290        <span class="keywordflow">case</span> ON :
00291            p1 = (int)round(image-&gt;aperture[net-&gt;aperture]-&gt;parameter[0] * trf.<a class="code" href="structgerb__transf.html#o1">scale</a>);
00292            <span class="keywordflow">if</span> (image-&gt;aperture[net-&gt;aperture]-&gt;type == RECTANGLE)
00293               gdk_gc_set_line_attributes(gc, p1, 
00294                                       GDK_LINE_SOLID, 
00295                                       GDK_CAP_PROJECTING, 
00296                                       GDK_JOIN_MITER);
00297            <span class="keywordflow">else</span>
00298               gdk_gc_set_line_attributes(gc, p1, 
00299                                       GDK_LINE_SOLID, 
00300                                       GDK_CAP_ROUND, 
00301                                       GDK_JOIN_MITER);
00302 
00303            <span class="keywordflow">switch</span> (net-&gt;interpolation) {
00304            <span class="keywordflow">case</span> LINEARx10 :
00305            <span class="keywordflow">case</span> LINEARx01 :
00306            <span class="keywordflow">case</span> LINEARx001 :
00307               GERB_MESSAGE(<span class="stringliteral">"Linear != x1\n"</span>);
00308               gdk_gc_set_line_attributes(gc, p1, 
00309                                       GDK_LINE_ON_OFF_DASH, 
00310                                       GDK_CAP_ROUND, 
00311                                       GDK_JOIN_MITER);
00312               gdk_draw_line(*pixmap, gc, x1, y1, x2, y2);
00313               gdk_gc_set_line_attributes(gc, p1, 
00314                                       GDK_LINE_SOLID,
00315                                       GDK_CAP_ROUND, 
00316                                       GDK_JOIN_MITER);
00317               <span class="keywordflow">break</span>;
00318            <span class="keywordflow">case</span> LINEARx1 :
00319               gdk_draw_line(*pixmap, gc, x1, y1, x2, y2);
00320               <span class="keywordflow">break</span>;
00321            <span class="keywordflow">case</span> CW_CIRCULAR :
00322            <span class="keywordflow">case</span> CCW_CIRCULAR :
00323                 <span class="comment">/* FIXME: angles have to be transformed (rotated)! */</span>
00324               gerbv_draw_arc(*pixmap, gc, cp_x, cp_y, cir_width, cir_height, 
00325                             net-&gt;cirseg-&gt;angle1, net-&gt;cirseg-&gt;angle2);
00326               <span class="keywordflow">break</span>;        
00327            <span class="keywordflow">default</span> :
00328               <span class="keywordflow">break</span>;
00329            }
00330            <span class="keywordflow">break</span>;
00331        <span class="keywordflow">case</span> OFF :
00332            <span class="keywordflow">break</span>;
00333        <span class="keywordflow">case</span> FLASH :
00334            p1 = (int)round(image-&gt;aperture[net-&gt;aperture]-&gt;parameter[0] * trf.<a class="code" href="structgerb__transf.html#o1">scale</a>);
00335            p2 = (int)round(image-&gt;aperture[net-&gt;aperture]-&gt;parameter[1] * trf.<a class="code" href="structgerb__transf.html#o1">scale</a>);
00336            
00337            <span class="keywordflow">switch</span> (image-&gt;aperture[net-&gt;aperture]-&gt;type) {
00338            <span class="keywordflow">case</span> CIRCLE :
00339               gerbv_draw_circle(*pixmap, gc, TRUE, x2, y2, p1);
00340               <span class="keywordflow">break</span>;
00341            <span class="keywordflow">case</span> RECTANGLE:
00342               gerbv_draw_rectangle(*pixmap, gc, TRUE, x2, y2, p1, p2);
00343               <span class="keywordflow">break</span>;
00344            <span class="keywordflow">case</span> OVAL :
00345               gerbv_draw_oval(*pixmap, gc, TRUE, x2, y2, p1, p2);
00346               <span class="keywordflow">break</span>;
00347            <span class="keywordflow">case</span> POLYGON :
00348               GERB_COMPILE_WARNING(<span class="stringliteral">"Very bad at drawing polygons.\n"</span>);
00349               gerbv_draw_circle(*pixmap, gc, TRUE, x2, y2, p1);
00350               <span class="keywordflow">break</span>;
00351            <span class="keywordflow">case</span> MACRO :
00352               gerbv_draw_amacro(*pixmap, gc, 
00353                               image-&gt;aperture[net-&gt;aperture]-&gt;amacro-&gt;program,
00354                               image-&gt;aperture[net-&gt;aperture]-&gt;amacro-&gt;nuf_push,
00355                               image-&gt;aperture[net-&gt;aperture]-&gt;parameter,
00356                               &amp;trf, x2, y2);
00357               <span class="keywordflow">break</span>;
00358            <span class="keywordflow">default</span> :
00359               GERB_MESSAGE(<span class="stringliteral">"Unknown aperture type\n"</span>);
00360               <span class="keywordflow">return</span> 0;
00361            }
00362            <span class="keywordflow">break</span>;
00363        <span class="keywordflow">default</span> :
00364            GERB_MESSAGE(<span class="stringliteral">"Unknown aperture state\n"</span>);
00365            <span class="keywordflow">return</span> 0;
00366        }
00367     }
00368 
00369     <span class="comment">/*</span>
00370 <span class="comment">     * Destroy GCs before exiting</span>
00371 <span class="comment">     */</span>
00372     gdk_gc_unref(gc);
00373     gdk_gc_unref(pgc);
00374     
00375     <span class="keywordflow">return</span> 1;
00376 
00377 } <span class="comment">/* image2pixmap */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Oct 13 16:09:18 2004 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.8-20040928 </small></address>
</body>
</html>
