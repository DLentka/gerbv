<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gerbv: src/gerb_image.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8-20040928 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>gerb_image.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
00003 <span class="comment"> * This files is a part of gerbv.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *   Copyright (C) 2000-2003 Stefan Petersen (spe@stacken.kth.se)</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * $Id$</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00011 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00012 <span class="comment"> * (at your option) any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00017 <span class="comment"> * GNU General Public License for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
00022 <span class="comment"> */</span>
00023 
00024 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00025 <span class="preprocessor">#include &lt;string.h&gt;</span>
00026 <span class="preprocessor">#include &lt;math.h&gt;</span>
00027 <span class="preprocessor">#include "gerb_image.h"</span>
00028 
00032 gerb_image_t *
00033 new_gerb_image(gerb_image_t *image)
00034 {
00035     free_gerb_image(image);
00036     
00037     <span class="keywordflow">if</span> ((image = (gerb_image_t *)malloc(<span class="keyword">sizeof</span>(gerb_image_t))) == NULL) {
00038        <span class="keywordflow">return</span> NULL;
00039     }
00040     memset((<span class="keywordtype">void</span> *)image, 0, <span class="keyword">sizeof</span>(gerb_image_t));
00041     
00042     <span class="keywordflow">if</span> ((image-&gt;netlist = (gerb_net_t *)malloc(<span class="keyword">sizeof</span>(gerb_net_t))) == NULL) {
00043        free(image);
00044        <span class="keywordflow">return</span> NULL;
00045     }
00046     memset((<span class="keywordtype">void</span> *)image-&gt;netlist, 0, <span class="keyword">sizeof</span>(gerb_net_t));
00047     
00048     <span class="keywordflow">if</span> ((image-&gt;info = (gerb_image_info_t *)malloc(<span class="keyword">sizeof</span>(gerb_image_info_t))) == NULL) {
00049        free(image-&gt;netlist);
00050        free(image);
00051        <span class="keywordflow">return</span> NULL;
00052     }
00053     memset((<span class="keywordtype">void</span> *)image-&gt;info, 0, <span class="keyword">sizeof</span>(gerb_image_info_t));
00054     
00055     <span class="keywordflow">if</span> ((image-&gt;transf = gerb_transf_new()) == NULL) {
00056         free(image-&gt;info);
00057         free(image-&gt;netlist);
00058        free(image);
00059        <span class="keywordflow">return</span> NULL;
00060     }
00061 
00062     
00063     image-&gt;info-&gt;min_x = HUGE_VAL;
00064     image-&gt;info-&gt;min_y = HUGE_VAL;
00065     image-&gt;info-&gt;max_x = -HUGE_VAL;
00066     image-&gt;info-&gt;max_y = -HUGE_VAL;
00067 
00068     image-&gt;info-&gt;step_and_repeat.X = 1;
00069     image-&gt;info-&gt;step_and_repeat.Y = 1;
00070 
00071     <span class="keywordflow">return</span> image;
00072 }
00073 
00074 
00075 <span class="keywordtype">void</span>
00076 free_gerb_image(gerb_image_t *image)
00077 {
00078     <span class="keywordtype">int</span> i;
00079     gerb_net_t *net, *tmp;
00080     
00081     <span class="keywordflow">if</span>(image==NULL)
00082         <span class="keywordflow">return</span>;
00083         
00084     <span class="comment">/*</span>
00085 <span class="comment">     * Free apertures</span>
00086 <span class="comment">     */</span>
00087     <span class="keywordflow">for</span> (i = 0; i &lt; APERTURE_MAX; i++) 
00088        <span class="keywordflow">if</span> (image-&gt;aperture[i] != NULL) {
00089            free(image-&gt;aperture[i]);
00090            image-&gt;aperture[i] = NULL;
00091        }
00092 
00093     <span class="comment">/*</span>
00094 <span class="comment">     * Free aperture macro</span>
00095 <span class="comment">     */</span>
00096     <span class="keywordflow">if</span> (image-&gt;amacro)
00097        free_amacro(image-&gt;amacro);
00098 
00099     <span class="comment">/*</span>
00100 <span class="comment">     * Free format</span>
00101 <span class="comment">     */</span>
00102     <span class="keywordflow">if</span> (image-&gt;format)
00103        free(image-&gt;format);
00104     
00105     <span class="comment">/*</span>
00106 <span class="comment">     * Free info</span>
00107 <span class="comment">     */</span>
00108     <span class="keywordflow">if</span> (image-&gt;info) {
00109        <span class="keywordflow">if</span> (image-&gt;info-&gt;name)
00110            free(image-&gt;info-&gt;name);
00111        free(image-&gt;info);
00112     }
00113     
00114     <span class="comment">/*</span>
00115 <span class="comment">     * Free netlist</span>
00116 <span class="comment">     */</span>
00117     <span class="keywordflow">for</span> (net = image-&gt;netlist; net != NULL; ) {
00118        tmp = net; 
00119        net = net-&gt;next; 
00120        <span class="keywordflow">if</span> (tmp-&gt;cirseg != NULL) {
00121            free(tmp-&gt;cirseg);
00122            tmp-&gt;cirseg = NULL;
00123        }
00124        free(tmp);
00125        tmp = NULL;
00126     }
00127     
00128  <span class="comment">//   gerb_transf_free(image-&gt;transf);</span>
00129 
00130     <span class="comment">/*</span>
00131 <span class="comment">     * Free and reset the final image</span>
00132 <span class="comment">     */</span>
00133     free(image);
00134     image = NULL;
00135     
00136     <span class="keywordflow">return</span>;
00137 } <span class="comment">/* free_gerb_image */</span>
00138 
00139 
00140 <span class="comment">/*</span>
00141 <span class="comment"> * Check that the parsed gerber image is complete.</span>
00142 <span class="comment"> * Returned errorcodes are:</span>
00143 <span class="comment"> * 0: No problems</span>
00144 <span class="comment"> * 1: Missing netlist</span>
00145 <span class="comment"> * 2: Missing format</span>
00146 <span class="comment"> * 4: Missing apertures</span>
00147 <span class="comment"> * 8: Missing info</span>
00148 <span class="comment"> * It could be any of above or'ed together</span>
00149 <span class="comment"> */</span>
00150 gerb_verify_error_t
00151 gerb_image_verify(gerb_image_t *image)
00152 {
00153     gerb_verify_error_t error = GERB_IMAGE_OK;
00154     <span class="keywordtype">int</span> i;
00155 
00156     <span class="keywordflow">if</span> (image-&gt;netlist == NULL) error |= GERB_IMAGE_MISSING_NETLIST;
00157     <span class="keywordflow">if</span> (image-&gt;format == NULL)  error |= GERB_IMAGE_MISSING_FORMAT;
00158     <span class="keywordflow">if</span> (image-&gt;info == NULL)    error |= GERB_IMAGE_MISSING_INFO;
00159 
00160     <span class="keywordflow">for</span> (i = 0; i &lt; APERTURE_MAX &amp;&amp; image-&gt;aperture[i] == NULL; i++);
00161     <span class="keywordflow">if</span> (i == APERTURE_MAX) error |= GERB_IMAGE_MISSING_APERTURES;
00162     
00163     <span class="keywordflow">return</span> error;
00164 } <span class="comment">/* gerb_image_verify */</span>
00165 
00166 
00167 <span class="keyword">static</span> <span class="keywordtype">void</span>
00168 gerb_image_interpolation(<span class="keyword">enum</span> interpolation_t interpolation)
00169 {
00170     <span class="keywordflow">switch</span> (interpolation) {
00171     <span class="keywordflow">case</span> LINEARx1:
00172        printf(<span class="stringliteral">"linearX1"</span>);
00173        <span class="keywordflow">break</span>;
00174     <span class="keywordflow">case</span> LINEARx10:
00175        printf(<span class="stringliteral">"linearX10"</span>);
00176        <span class="keywordflow">break</span>;
00177     <span class="keywordflow">case</span> LINEARx01:
00178        printf(<span class="stringliteral">"linearX01"</span>);
00179        <span class="keywordflow">break</span>;
00180     <span class="keywordflow">case</span> LINEARx001:
00181        printf(<span class="stringliteral">"linearX001"</span>);
00182        <span class="keywordflow">break</span>;
00183     <span class="keywordflow">case</span> CW_CIRCULAR:
00184        printf(<span class="stringliteral">"CW circular"</span>);
00185        <span class="keywordflow">break</span>;
00186     <span class="keywordflow">case</span> CCW_CIRCULAR:
00187        printf(<span class="stringliteral">"CCW circular"</span>);
00188        <span class="keywordflow">break</span>;
00189     <span class="keywordflow">case</span>  PAREA_START:
00190        printf(<span class="stringliteral">"polygon area start"</span>);
00191        <span class="keywordflow">break</span>;
00192     <span class="keywordflow">case</span>  PAREA_END:
00193        printf(<span class="stringliteral">"polygon area end"</span>);
00194        <span class="keywordflow">break</span>;
00195     <span class="keywordflow">default</span>:
00196        printf(<span class="stringliteral">"unknown"</span>);
00197     }
00198 } <span class="comment">/* gerb_image_interpolation */</span>
00199 
00200 
00201 <span class="comment">/* Dumps a written version of image to stdout */</span>
00202 <span class="keywordtype">void</span> 
00203 gerb_image_dump(gerb_image_t *image)
00204 {
00205     <span class="keywordtype">int</span> i, j;
00206     gerb_aperture_t **aperture;
00207     gerb_net_t *net;
00208 
00209     <span class="comment">/* Apertures */</span>
00210     printf(<span class="stringliteral">"Apertures:\n"</span>);
00211     aperture = image-&gt;aperture;
00212     <span class="keywordflow">for</span> (i = 0; i &lt; APERTURE_MAX; i++) {
00213        <span class="keywordflow">if</span> (aperture[i]) {
00214            printf(<span class="stringliteral">" Aperture no:%d is an "</span>, i);
00215            <span class="keywordflow">switch</span>(aperture[i]-&gt;type) {
00216            <span class="keywordflow">case</span> CIRCLE:
00217               printf(<span class="stringliteral">"circle"</span>);
00218               <span class="keywordflow">break</span>;
00219            <span class="keywordflow">case</span> RECTANGLE:
00220               printf(<span class="stringliteral">"rectangle"</span>);
00221               <span class="keywordflow">break</span>;
00222            <span class="keywordflow">case</span> OVAL:
00223               printf(<span class="stringliteral">"oval"</span>);
00224               <span class="keywordflow">break</span>;
00225            <span class="keywordflow">case</span> POLYGON:
00226               printf(<span class="stringliteral">"polygon"</span>);
00227               <span class="keywordflow">break</span>;
00228            <span class="keywordflow">case</span> MACRO:
00229               printf(<span class="stringliteral">"macro"</span>);
00230               <span class="keywordflow">break</span>;
00231            <span class="keywordflow">default</span>:
00232               printf(<span class="stringliteral">"unknown"</span>);
00233            }
00234            <span class="keywordflow">for</span> (j = 0; j &lt; aperture[i]-&gt;nuf_parameters; j++) {
00235               printf(<span class="stringliteral">" %f"</span>, aperture[i]-&gt;parameter[j]);
00236            }
00237            printf(<span class="stringliteral">"\n"</span>);
00238        }
00239     }
00240 
00241     <span class="comment">/* Netlist */</span>
00242     net = image-&gt;netlist;
00243     <span class="keywordflow">while</span> (net){
00244        printf(<span class="stringliteral">"(%f,%f)-&gt;(%f,%f) with %d ("</span>, net-&gt;start_x, net-&gt;start_y, 
00245               net-&gt;stop_x, net-&gt;stop_y, net-&gt;aperture);
00246        gerb_image_interpolation(net-&gt;interpolation);
00247        printf(<span class="stringliteral">")\n"</span>);
00248        net = net-&gt;next;
00249     }
00250 } <span class="comment">/* gerb_image_dump */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Oct 13 16:09:18 2004 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.8-20040928 </small></address>
</body>
</html>
