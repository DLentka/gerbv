<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gerbv: src/search_cb.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8-20040928 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>search_cb.c</h1><a href="search__cb_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
00003 <span class="comment"> * This file is a part of gerbv.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *   Copyright (C) 2004 Juergen Haas (juergenhaas@gmx.net)</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * $Id$</span>
00008 <span class="comment"> *  </span>
00009 <span class="comment"> *                                      Juergen H. (juergenhaas@gmx.net) </span>
00010 <span class="comment"> *                                      and Tomasz M. (T.Motylewski@bfad.de)</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00013 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00014 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00015 <span class="comment"> * (at your option) any later version.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00018 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00019 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00020 <span class="comment"> * GNU General Public License for more details.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00023 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00024 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
00025 <span class="comment"> */</span>
00026  
00032 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#ifdef USE_GTK2</span>
00037 <span class="preprocessor"></span>
00038 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00039 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00040 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00041 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00042 <span class="preprocessor">#include &lt;math.h&gt;</span>
00043 
00044 <span class="preprocessor">#ifdef HAVE_LIBGEN_H</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#include &lt;libgen.h&gt;</span> <span class="comment">/* dirname */</span>
00046 <span class="preprocessor">#endif</span>
00047 <span class="preprocessor"></span>
00048 
00049 <span class="preprocessor">#ifdef HAVE_STRING_H</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
00055 <span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span>
00057 <span class="preprocessor">#include &lt;gtk/gtk.h&gt;</span>
00058 <span class="preprocessor">#include &lt;gdk/gdk.h&gt;</span>
00059 <span class="preprocessor">#include &lt;gdk/gdkkeysyms.h&gt;</span>
00060 
00061 <span class="preprocessor">#ifdef HAVE_GETOPT_H</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#include &lt;getopt.h&gt;</span>
00063 <span class="preprocessor">#endif</span>
00064 <span class="preprocessor"></span>
00065 <span class="preprocessor">#ifdef USE_GTK2</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#include &lt;pango/pango.h&gt;</span>
00067 <span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>
00069 <span class="preprocessor">#include "gerber.h"</span>
00070 <span class="preprocessor">#include "drill.h"</span>
00071 <span class="preprocessor">#include "gerb_error.h"</span>
00072 <span class="preprocessor">#include "draw.h"</span>
00073 <span class="preprocessor">#include "color.h"</span>
00074 <span class="preprocessor">#include "gerbv_screen.h"</span>
00075 <span class="preprocessor">#include "gerbv_icon.h"</span>
00076 <span class="preprocessor">#include "search.h"</span>
00077 <span class="preprocessor">#include "search_file.h"</span>
00078 <span class="preprocessor">#include "search_gui.h"</span>
00079 <span class="preprocessor">#include "search_cb.h"</span>
00080 <span class="preprocessor">#include "log.h"</span>
00081 <span class="preprocessor">#include "setup.h"</span>
00082 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00083 
00084 
00085 <span class="keyword">static</span> <span class="keywordtype">void</span>
00086 cb_ok_load_pnp_file(GtkWidget *widget, GtkFileSelection *fs)
00087 {
00088     <span class="keywordtype">char</span> *filename;
00089 
00090     filename = (<span class="keywordtype">char</span> *)gtk_file_selection_get_filename(GTK_FILE_SELECTION(fs));
00091 
00092 <span class="preprocessor">#if 0</span>
00093 <span class="preprocessor"></span>    <a class="code" href="gerbv_8c.html#a0">screen</a>.file[19] = (gerbv_fileinfo_t *)malloc(<span class="keyword">sizeof</span>(gerbv_fileinfo_t));<span class="comment">/*allocate memory for new layer data*/</span>
00094     memset((<span class="keywordtype">void</span> *)<a class="code" href="gerbv_8c.html#a0">screen</a>.file[19], 0, <span class="keyword">sizeof</span>(gerbv_fileinfo_t));
00095     <a class="code" href="gerbv_8c.html#a0">screen</a>.file[19]-&gt;name = (<span class="keywordtype">char</span> *)malloc(strlen(filename) + 1);
00096     strncpy(<a class="code" href="gerbv_8c.html#a0">screen</a>.file[19]-&gt;name, filename, strlen(filename));<span class="comment">/*entry for pnp file also getting saved on "save project"*/</span>
00097     <a class="code" href="gerbv_8c.html#a0">screen</a>.file[19]-&gt;inverted = 0;
00098 <span class="preprocessor">#endif    </span>
00099 <span class="preprocessor"></span>    
00100     <a class="code" href="search__gui_8c.html#a8">create_search_window</a>(widget, NULL);
00101     
00102     <span class="keywordflow">if</span> (<a class="code" href="search__cb_8c.html#a3">open_pnp</a>(filename, <a class="code" href="gerbv_8c.html#a0">screen</a>.curr_index, FALSE) != -1) {
00103         
00104         interface.<a class="code" href="struct__InterfaceStruct.html#o21">pnp_filename</a> = (<span class="keywordtype">char</span> *)malloc(strlen(filename) + 1);
00105         strcpy(interface.<a class="code" href="struct__InterfaceStruct.html#o21">pnp_filename</a>, filename);<span class="comment">/*entry for pnp file also getting saved on "save project"*/</span>
00106         
00107 <span class="preprocessor">#ifdef HAVE_LIBGEN_H</span>
00108 <span class="preprocessor"></span>        <span class="comment">/*</span>
00109 <span class="comment">         * Remember where we loaded file from last time</span>
00110 <span class="comment">         */</span>
00111         filename = dirname(filename);
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>            <span class="comment">/*CHECK ME:do we need the following lines?, screen.path should be based on the gerberfiles*/</span>
00114         <span class="keywordflow">if</span> (<a class="code" href="gerbv_8c.html#a0">screen</a>.path) 
00115                free(<a class="code" href="gerbv_8c.html#a0">screen</a>.path);
00116            
00117         <a class="code" href="gerbv_8c.html#a0">screen</a>.path = (<span class="keywordtype">char</span> *)malloc(strlen(filename) + 1);
00118         strcpy(<a class="code" href="gerbv_8c.html#a0">screen</a>.path, filename);
00119         <a class="code" href="gerbv_8c.html#a0">screen</a>.path = strncat(<a class="code" href="gerbv_8c.html#a0">screen</a>.path, <span class="stringliteral">"/"</span>, 1);
00120     }
00121     gtk_grab_remove(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00122     gtk_widget_destroy(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00123     <a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file = NULL;
00124 
00125     <span class="keywordflow">return</span>;
00126 } <span class="comment">/* cb_ok_load_pnp_file */</span>
00127 
00128 
00129 
00130 <span class="keyword">static</span> <span class="keywordtype">void</span>
00131 cb_cancel_load_file(GtkWidget *widget, gpointer data)
00132 {
00133     gtk_grab_remove(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00134     gtk_widget_destroy(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00135     <a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file = NULL;
00136 
00137     <span class="keywordflow">return</span>;
00138 } <span class="comment">/* cb_cancel_load_file */</span>
00139 
00140 
00143 <span class="keywordtype">void</span>
<a name="l00144"></a><a class="code" href="search__cb_8c.html#a2">00144</a> <a class="code" href="search__cb_8c.html#a2">load_pnp_file_popup</a>(GtkWidget *widget, gpointer data)
00145 {
00146 
00147     <a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file = gtk_file_selection_new(<span class="stringliteral">"Select 'Pick and Place' File"</span>);
00148     
00149     <span class="keywordflow">if</span> (<a class="code" href="gerbv_8c.html#a0">screen</a>.path)
00150        gtk_file_selection_set_filename
00151            (GTK_FILE_SELECTION(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file), <a class="code" href="gerbv_8c.html#a0">screen</a>.path);
00152 
00153     gtk_signal_connect(GTK_OBJECT(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file), <span class="stringliteral">"destroy"</span>,
00154                      GTK_SIGNAL_FUNC(cb_cancel_load_file),
00155                      NULL);
00156 
00157     gtk_signal_connect
00158        (GTK_OBJECT(GTK_FILE_SELECTION(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file)-&gt;ok_button),
00159         <span class="stringliteral">"clicked"</span>, GTK_SIGNAL_FUNC(cb_ok_load_pnp_file), 
00160         (gpointer)<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00161          
00162     gtk_signal_connect
00163        (GTK_OBJECT(GTK_FILE_SELECTION(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file)-&gt;cancel_button),
00164         <span class="stringliteral">"clicked"</span>, GTK_SIGNAL_FUNC(cb_cancel_load_file), 
00165         (gpointer)<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00166     
00167     gtk_widget_show(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00168 
00169     gtk_grab_add(<a class="code" href="gerbv_8c.html#a0">screen</a>.win.load_file);
00170        
00171     <span class="keywordflow">return</span>;
00172 } <span class="comment">/* load_pnp_file_popup */</span>
00173 
00175 
00179 <span class="keywordtype">int</span>
<a name="l00180"></a><a class="code" href="search__cb_8c.html#a3">00180</a> <a class="code" href="search__cb_8c.html#a3">open_pnp</a>(<span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> idx, <span class="keywordtype">int</span> reload)
00181 {
00182     <a class="code" href="structpnp__file.html">pnp_file_t</a>  *fd;
00183    
00184     <span class="keywordtype">char</span> *cptr;
00185 
00186     <span class="keywordflow">if</span> (idx &gt;= MAX_FILES) {
00187            GERB_MESSAGE(<span class="stringliteral">"Couldn't open %s. Maximum number of files opened.\n"</span>,
00188                    filename);
00189         <span class="keywordflow">return</span> -1;
00190     }
00191      <span class="comment">/*</span>
00192 <span class="comment">     *FIX ME RELOAD </span>
00193 <span class="comment">     */</span>
00194     fd = <a class="code" href="search__file_8c.html#a1">pnp_fopen</a>(filename);
00195     <span class="keywordflow">if</span> (fd == NULL) {
00196            GERB_MESSAGE(<span class="stringliteral">"Trying to open %s:%s\n"</span>, filename, strerror(errno));
00197            <span class="keywordflow">return</span> -1;
00198     }
00199     
00200     <span class="comment">/*Global storage, TODO: for data reload*/</span>
00201     parsed_PNP_data = <a class="code" href="search_8c.html#a3">parse_pnp</a>(fd);
00202     <a class="code" href="search__file_8c.html#a2">pnp_fclose</a>(fd);
00203          
00204     <span class="keywordflow">if</span>(!gtk_tree_model_get_iter_first (GTK_TREE_MODEL(interface.<a class="code" href="struct__InterfaceStruct.html#o17">model</a>), &amp;interface.<a class="code" href="struct__InterfaceStruct.html#o20">iter</a>)) {
00205         GERB_MESSAGE(<span class="stringliteral">"Non compatible PNP file\n change to csv format using ',' ':' '|' ';' as delimiters (quotes are supported)\n"</span>);
00206         <span class="keywordflow">if</span> (interface.<a class="code" href="struct__InterfaceStruct.html#o2">main_window</a> != NULL)
00207             gtk_widget_destroy(interface.<a class="code" href="struct__InterfaceStruct.html#o2">main_window</a>);
00208         <span class="keywordflow">if</span> (parsed_PNP_data)
00209             <a class="code" href="search_8c.html#a4">free_pnp_state</a>(parsed_PNP_data);
00210     }
00211         
00212     <span class="keywordflow">return</span> 0; <span class="comment">/* CHECKME */</span>
00213     <span class="comment">/*</span>
00214 <span class="comment">     * set up properties</span>
00215 <span class="comment">     */</span>
00216    
00217     cptr = strrchr(filename, path_separator);
00218     <span class="keywordflow">if</span> (cptr) {
00219            <span class="keywordtype">int</span> len;
00220 
00221            len = strlen(cptr);
00222            <a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;basename = (<span class="keywordtype">char</span> *)malloc(len + 1);
00223            <span class="keywordflow">if</span> (<a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;basename) {
00224                strncpy(<a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;basename, cptr+1, len);
00225                <a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;basename[len] = <span class="charliteral">'\0'</span>;
00226            } <span class="keywordflow">else</span> {
00227                <a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;basename = <a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;name;
00228            }
00229     } <span class="keywordflow">else</span> {
00230            <a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;basename = <a class="code" href="gerbv_8c.html#a0">screen</a>.file[idx]-&gt;name;
00231     }
00232  
00233     <span class="keywordflow">return</span> 0;
00234     
00235 } <span class="comment">/* open_pnp */</span>
00236 <span class="preprocessor">#endif </span><span class="comment">/* USE_GTK2 */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Oct 13 16:09:21 2004 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.8-20040928 </small></address>
</body>
</html>
